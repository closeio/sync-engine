version: 2.1
jobs:
  build:

    docker:
      - image: circleci/python:2.7

    working_directory: ~/inbox

    steps:
      - checkout

      - setup_remote_docker

      - run:
          name: build nylas image
          command: docker-compose build nylas && docker-compose down

      - run:
          name: bring up mysql and redis
          command: docker-compose up mysql redis
          background: true

      - run:
          name: build image and run tests
          command: |
            docker-compose run nylas bash -ec '
              bin/wait-for-it.sh mysql:3306 \
              && NYLAS_ENV=test py.test inbox/test/
            '
