version: 2.1
jobs:
  build:

    docker:
      - image: circleci/python:2.7

    working_directory: ~/inbox

    steps:
      - checkout

      - setup_remote_docker

      - run:
          name: build nylas image
          command: docker-compose build nylas

      - run:
          name: bring up mysql and redis
          command: docker-compose up -d mysql redis

      - run:
          name: install dockerize
          command: wget https://github.com/jwilder/dockerize/releases/download/$DOCKERIZE_VERSION/dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz && sudo tar -C /usr/local/bin -xzvf dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz && rm dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz
          environment:
            DOCKERIZE_VERSION: v0.3.0

      - run:
          name: Wait for db to come up
          command: dockerize -wait tcp://mysql:3306 -timeout 1m

      - run:
          name: build image and run tests
          command: docker-compose run nylas bash -c "NYLAS_ENV=test py.test inbox/test/"
