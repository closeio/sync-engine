version: 2.1
jobs:
  static-code-analysis:
    docker:
      - image: cimg/python:3.8
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PASS
    working_directory: ~/code
    steps:
      - checkout

      - run:
          name: Prepare Environment
          command: |
            pip install --no-deps -r requirements/lint.txt

      - run:
          name: black
          when: always
          command: black --check .

      - run:
          name: isort
          when: always
          command: isort -c .

      - run:
          name: flake8
          command: flake8

      - run:
          name: mypy
          command: |
            mypy \
            -p inbox.actions \
            -p inbox.api \
            -p inbox.auth \
            -p inbox.contacts \
            -p inbox.events \
            -p inbox.heartbeat \
            -p inbox.mailsync \
            -p inbox.models.account \
            -p inbox.models.action_log \
            -p inbox.models.base \
            -p inbox.models.block \
            -p inbox.models.calendar \
            -p inbox.models.constants \
            -p inbox.models.contact \
            -p inbox.models.data_processing \
            -p inbox.models.folder \
            -p inbox.models.label \
            -p inbox.models.metadata \
            -p inbox.models.namespace \
            -p inbox.models.roles \
            -p inbox.models.search \
            -p inbox.models.secret \
            -p inbox.models.session \
            -p inbox.models.thread \
            -p inbox.models.transaction \
            -p inbox.models.util \
            -p inbox.models.when \
            -p inbox.s3 \
            -p inbox.scheduling \
            -p inbox.search \
            -p inbox.security \
            -p inbox.sendmail \
            -p inbox.sqlalchemy_ext \
            -p inbox.sync \
            -p inbox.util \
            -p inbox.webhooks \
            -p inbox.basicauth \
            -p inbox.config \
            -p inbox.console \
            -p inbox.crispin \
            -p inbox.error_handling \
            -p inbox.folder_edge_cases \
            -p inbox.ignition \
            -p inbox.instrumentation \
            -p inbox.logging \
            -p inbox.providers

  build:
    parameters:
      platform_suffix:
        type: enum
        default: ""
        description: Platform tag, empty means amd64
        enum: ["", "-arm64"]
      resource_class:
        type: enum
        default: "medium"
        description: Resource class
        enum: ["medium", "arm.medium"]
      run_tests:
        type: boolean
        default: true
        description: Set to false to disable tests
      push_image:
        type: boolean
        default: true
        description: Set to false to disable pushing image
    machine:
      image: ubuntu-2204:current
    resource_class: <<parameters.resource_class>>
    working_directory: ~/sync-engine

    steps:
      - checkout

      - run:
          name: Prepare Backend environment
          command: |
            docker login -u $DOCKER_USER -p $DOCKER_PASS

            if [ "$(git log -1 --pretty=%B | head -n 1 | grep '#notests')" ]; then
              echo 'export SKIP_TESTS="1"' >> $BASH_ENV
            fi

      - run:
          name: build sync-engine image
          command: docker-compose build --build-arg BUILD_WEEK=$(date +"%Y-%V") app

      - when:
          condition: << parameters.run_tests >>
          steps:
            - run:
                name: run tests
                command: |
                  if [[ -z $SKIP_TESTS ]]; then
                    MYSQL_VERSION=8.0.28 docker-compose run app bash -ec '
                      bin/wait-for-it.sh mysql:3306 \
                      && pytest --cov-report= --cov=inbox tests/ \
                      && coverage html -d pythoncov
                    '
                  else
                    echo Skipping tests
                  fi
      
      - when:
          condition: << parameters.push_image >>
          steps:
            - run:
                name: Push the image to docker hub
                environment:
                  PROJECT: sync-engine
                  PROJECT_NAMESPACE: closeio
                command: |
                  PROJECT_VSN="$CIRCLE_BRANCH"
                  PROJECT_SHA="$CIRCLE_SHA1"
                  docker login -u $DOCKER_USER -p $DOCKER_PASS
                  # tag and push both sync-engine:master and sync-engine:<sha1>
                  docker tag "${PROJECT}_app" "${PROJECT_NAMESPACE}/${PROJECT}:branch-${PROJECT_VSN}<< parameters.platform_suffix >>"
                  docker tag "${PROJECT}_app" "${PROJECT_NAMESPACE}/${PROJECT}:${PROJECT_SHA}<< parameters.platform_suffix >>"
                  docker push "${PROJECT_NAMESPACE}/${PROJECT}:branch-${PROJECT_VSN}<< parameters.platform_suffix >>"
                  docker push "${PROJECT_NAMESPACE}/${PROJECT}:${PROJECT_SHA}<< parameters.platform_suffix >>"

      - when:
          condition: << parameters.run_tests >>
          steps:
            - store_artifacts:
                path: pythoncov

            - store_artifacts:
                path: .circleci/artifacts.html
                destination: artifacts.html

workflows:
  version: 2
  workflow:
    jobs:
      - static-code-analysis
      - build:
          name: build
      - build:
          name: build_arm
          resource_class: "arm.medium"
          platform_suffix: "-arm64"
          run_tests: false
